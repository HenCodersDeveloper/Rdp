name: Windows Latest

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest

    timeout-minutes: 9999

    steps:
    - name: Download Core Files
      run: |
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/HenCodersDeveloper/Rdp/refs/heads/main/start.bat -OutFile start.bat
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/HenCodersDeveloper/Rdp/refs/heads/main/loop.bat -OutFile loop.bat

    - name: Install OpenSSH (If not already installed)
      run: |
        $OpenSshInstalled = Get-WindowsCapability -Online | Where-Object { $_.Name -like 'OpenSSH.Client*' -and $_.State -eq 'Installed' }
        if (-not $OpenSshInstalled) {
          Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
        }
        Get-WindowsCapability -Online | Where-Object { $_.Name -like 'OpenSSH.Client*' }

    - name: Enabling access to RDP
      run: | 
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

    - name: Open Serveo Tunnel
      run: |
        Start-Process Powershell -ArgumentList '-Noexit -Command "ssh -R 3389:localhost:3389 serveo.net"'

    - name: Connect to your RDP
      run: cmd /c start.bat

    - name: Successfully made! You can close the tab now.
      run: cmd /c loop.bat
